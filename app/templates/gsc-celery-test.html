{% extends "/default/loggedin-base.html" %}

{% block title %} Sitewide Overview for {{ selected_property}} {% endblock %}

{% block content %}
<!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.3.4/dist/css/datepicker.min.css">

<script src="https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.3.4/dist/js/datepicker-full.min.js"></script> -->

<!-- Website Name & Brand Term Section-->


<div class="flex flex-row">

  <div role="alert" class="alert alert-success max-w-fit pr-10">
    <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
    <b>GSC Property : </b>
    <span>{{ selected_property}}</span>
  </div>

  <div role="alert" class="alert alert-success max-w-fit pr-10 ml-10">
    <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
    <span><b>Brand Terms :</b>  {{ brand_keywords }}</span>
  </div>

</div>

<div class="row-auto p-2">

  <!-- H1 Heading -->
  <div class="row-auto p-2">
    <h1 class="text-5xl font-bold mt-5 mb-5 justify-center flex-row">Sitewide Overview</h1>
    <div role="alert" class="alert max-w-fit inline-block">
      <p class="text-lg mt-2">ðŸ”‹ What's more than Google Search Console?</p>
      <p class="text-sm mt-2">
        ðŸ’¡ GSC Metrics(Clicks, Impressions, CTR, Positions) in Aggregate, By Country & By Device
        <br>ðŸ’¡ Period over Period and Year over Year Comaparison
        <br>ðŸ’¡ Filtering & Sorting Options for each Columns
        <br>ðŸ’¡ Export Data in CSV, Excel, PDF or Print
        <br>ðŸ’¡ No Limit of 1000 Rows of Data
    </div>
  </div>
  
  
  <!-- GSC Data Form -->
  <div class="row-auto p-2">

    <div id="reportrange" style="background: #fff; cursor: pointer; padding: 5px 10px; border: 1px solid #ccc;" class="inline-block max-w-fit mr-5">
      <i class="fa fa-calendar"></i>&nbsp;
      <span></span> <i class="fa fa-caret-down"></i>
    </div>
    
    <form id="dateRangeForm" hx-post="/gsc-celery-test/" 
        hx-trigger="submit" hx-target="#taskStatus" hx-swap="innerHTML" hx-indicator="#loading-spinner">
        <input type="hidden" name="start_date" id="start_date">
        <input type="hidden" name="end_date" id="end_date">
        <button type="submit" class="btn btn-primary">Fetch Data</button>
        <span class="loading loading-dots loading-lg htmx-indicator" id="loading-spinner"></span>
    </form>

    <!-- Fetch Task Status-->
    <div id="taskStatus">
        <p>Task status will appear here...</p>
    </div>

    <!-- Fetch Data from Celery Task -->

    <div id="response-container">

    </div>

    
  </div>

 
  <script>
    // Function to check task status and update the frontend
    function checkTaskStatus(taskId) {
        const statusUrl = `/task-status/${taskId}`;
  
        fetch(statusUrl)
            .then(response => response.json())
            .then(data => {
                console.log('Task status data:', data); // Log the data to console
                if (data.status === 'completed') {
                    console.log('Data fetched from task:', data.data); // Log the fetched data
                    document.getElementById('response-container').innerHTML = `<p>Data fetched: ${data.data}</p>`;
                } else if (data.status === 'failed') {
                    document.getElementById('response-container').innerHTML = `<p>Task failed: ${data.error}</p>`;
                } else {
                    // Poll again after a delay if the task is still pending
                    setTimeout(() => checkTaskStatus(taskId), 5000); // Poll every 5 seconds
                }
            })
            .catch(error => {
                console.error('Error fetching task status:', error);
            });
    }
  
    // Listen for the HTMX event after form swap
    document.addEventListener('htmx:afterSwap', function(event) {
        if (event.detail.target.id === 'taskStatus') {
            const taskId = event.detail.xhr.responseJSON.task_id;
            if (taskId) {
                // Start polling for task status
                checkTaskStatus(taskId);
            } else {
                console.error('No task ID received from the server.');
            }
        }
    });
  </script>
  


<script type="text/javascript">
  $(function() {
  
      var start = moment().subtract(31, 'days');
      var end = moment().subtract(2, 'days');
  
      function cb(start, end) {
          $('#reportrange span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
          $('#start_date').val(start.format('MM/DD/YYYY'));
          $('#end_date').val(end.format('MM/DD/YYYY'));
      }
  
      $('#reportrange').daterangepicker({
          startDate: start,
          endDate: end,
          ranges: {
             'Today': [moment(), moment()],
             'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
             'Last 7 Days': [moment().subtract(6, 'days'), moment()],
             'Last 30 Days': [moment().subtract(29, 'days'), moment()],
             'This Month': [moment().startOf('month'), moment().endOf('month')],
             'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
          }
      }, cb);
  
      cb(start, end);
  
  });
</script>



{% endblock %}
