{% extends "/default/loggedin-base.html" %}

{% block title %} Long-Tail Opportunities for {{ selected_property}} {% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.3.4/dist/css/datepicker.min.css">
<script src="https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.3.4/dist/js/datepicker-full.min.js"></script>

<div class="container mx-auto px-4 max-w-7xl">
  <!-- Property Info Cards -->
  <div class="flex flex-col sm:flex-row gap-4 mb-8">
    <div role="alert" class="alert bg-success bg-opacity-10 shadow-lg">
      <svg xmlns="http://www.w3.org/2000/svg" class="stroke-success shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <div>
        <div class="text-sm opacity-75">GSC Property</div>
        <div class="font-bold">{{ selected_property}}</div>
      </div>
    </div>
  </div>

  <!-- H1 Heading -->
  <div class="mb-8">
    <h1 class="text-4xl font-bold mb-8">Long-Tail Opportunities</h1>

    <div class="mb-8">
      <!-- Filter Form -->
      <form id="filterForm" hx-post="/reports/query-length-analysis/" hx-swap="innerHTML"
        hx-target="#query-length-results" class="flex flex-col gap-4">

        <div class="flex flex-wrap items-center gap-3">
          <!-- Date Range Picker -->
          <div id="reportrange"
            class="bg-white cursor-pointer px-3 py-2 border border-base-300 rounded-lg hover:bg-base-100 transition-colors">
            <i class="fa fa-calendar"></i>&nbsp;
            <span></span> <i class="fa fa-caret-down"></i>
          </div>
          <input type="hidden" name="start_date" id="start_date">
          <input type="hidden" name="end_date" id="end_date">

          <!-- Country Filter -->
          <select name="country" class="select select-bordered w-full max-w-xs">
            <option value="All" selected>All Countries</option>
            {% for country in countries %}
            <option value="{{ country.code }}">{{ country.code }} - {{ country.impressions_formatted }} Impressions
            </option>
            {% endfor %}
          </select>

          <!-- Word Count Range Filters -->
          <div class="join">
            <div class="join-item">
              <input type="number" name="min_words" placeholder="Min Words (e.g. 3)"
                class="input input-bordered w-32 join-item" min="1">
            </div>
            <div class="join-item flex items-center bg-base-200 px-2 font-bold">-</div>
            <div class="join-item">
              <input type="number" name="max_words" placeholder="Max Words" class="input input-bordered w-32 join-item"
                min="1">
            </div>
          </div>

          <!-- Fetch Data Button -->
          <button type="submit" class="btn btn-primary">Fetch Data</button>
          <span class="loading loading-dots loading-lg htmx-indicator"></span>
        </div>
      </form>
    </div>

    <div class="collapse collapse-plus bg-base-200 rounded-lg shadow-sm mb-6">
      <input type="checkbox" class="peer" />
      <div class="collapse-title text-lg font-medium cursor-pointer">
        üîã What are Long-Tail Opportunities?
      </div>
      <div class="collapse-content">
        <p class="text-sm mt-2">
          üí° Analyze performance based on the specific word count of search queries.
          <br>üìà Identify "Long Tail" opportunities (longer queries often have lower competition and higher intent).
          <br>üîç Filter by Word Count range to target specific segments.
        </p>
      </div>
    </div>
  </div>

  <!-- Hidden skeleton template -->
  <div id="skeleton-template" style="display: none;">
    <div class="animate-pulse space-y-4">
      <div class="h-4 bg-gray-200 rounded w-3/4"></div>
      <div class="space-y-3">
        <div class="grid grid-cols-3 gap-4">
          <div class="h-40 bg-gray-200 rounded col-span-2"></div>
          <div class="h-40 bg-gray-200 rounded col-span-1"></div>
        </div>
        <div class="h-4 bg-gray-200 rounded"></div>
        <div class="h-4 bg-gray-200 rounded"></div>
      </div>
    </div>
  </div>

  <!-- Content Area -->
  <div id="query-length-results" class="mt-8">
    <!-- Initial State -->
    <div class="mt-10 text-center">
      <div role="alert" class="alert alert-info shadow-lg max-w-3xl mx-auto mb-5">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <div>
          <h3 class="font-bold">Ready to analyze!</h3>
          <div class="text-sm">
            Select dates and optionally a word count range, then click <strong>"Fetch Data"</strong>.
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">
  $(function () {
    var start = moment().subtract(29, 'days');
    var end = moment().subtract(2, 'days'); // GSC data is usually 2 days delayed

    function cb(start, end) {
      $('#reportrange span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
      $('#start_date').val(start.format('MM/DD/YYYY'));
      $('#end_date').val(end.format('MM/DD/YYYY'));
    }

    $('#reportrange').daterangepicker({
      startDate: start,
      endDate: end,
      ranges: {
        'Last 7 Days': [moment().subtract(8, 'days'), moment().subtract(2, 'days')], // Adjust for GSC delay
        'Last 28 Days': [moment().subtract(29, 'days'), moment().subtract(2, 'days')],
        'Last 3 Months': [moment().subtract(3, 'month').subtract(2, 'days'), moment().subtract(2, 'days')],
        'This Month': [moment().startOf('month'), moment().endOf('month')],
        'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
      }
    }, cb);

    cb(start, end);
  });

  // Show skeleton screen when HTMX request starts
  document.body.addEventListener('htmx:beforeRequest', function (event) {
    const form = event.detail.elt;
    if (form && form.id === 'filterForm') {
      const target = document.getElementById('query-length-results');
      const skeletonTemplate = document.getElementById('skeleton-template');

      if (target && skeletonTemplate) {
        target.innerHTML = `
          <div role="alert" class="alert alert-info shadow-lg max-w-3xl mb-6">
            <span class="loading loading-spinner loading-sm"></span>
            <span>Analyzing query lengths... This may take a moment.</span>
          </div>
          ${skeletonTemplate.innerHTML}
        `;
      }
    }
  });
</script>
{% endblock %}