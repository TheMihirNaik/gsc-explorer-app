{% extends "/default/loggedin-base.html" %}

{% block title %} Sitewide Analysis for {{ selected_property}} {% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.3.4/dist/css/datepicker.min.css">

<script src="https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.3.4/dist/js/datepicker-full.min.js"></script>

<div class="container px-4 max-w-7xl">
  <!-- Property Info Cards -->
  <div class="flex flex-col sm:flex-row gap-4 mb-4">
    <div role="alert" class="alert bg-success bg-opacity-10 shadow-lg">
        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-success shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <div>
            <div class="text-sm opacity-75">GSC Property</div>
            <div class="font-bold">{{ selected_property}}</div>
        </div>
    </div>

    <div role="alert" class="alert bg-success bg-opacity-10 shadow-lg">
        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-success shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <div>
            <div class="text-sm opacity-75">Brand Terms</div>
            <div class="font-bold">{{ brand_keywords }}</div>
        </div>
    </div>
  </div>
</div>

<div class="row-auto">
  <!-- H1 Heading -->
  <div class="row-auto p-2 align-middle">
    <h1 class="text-5xl font-bold mt-5 mb-5 justify-center flex-row">Sitewide Analysis</h1>


    <div class="flex flex-row">
        <!-- Date Range Picker -->
        <div id="reportrange" style="background: #fff; cursor: pointer; padding: 5px 10px; border: 1px solid #ccc;" 
        class="inline-block max-w-fit mr-5 align-middle">
        <i class="fa fa-calendar"></i>&nbsp;
        <span></span> <i class="fa fa-caret-down"></i>
        </div>

        <!-- Fetch Data Button -->

        <form id="dateRangeForm" hx-post="/charts/sitewide-brand-vs-non-brand/" hx-swap="innerHTML" hx-target="#sitewide-analysis" class="inline-block">
        <input type="hidden" name="start_date" id="start_date">
        <input type="hidden" name="end_date" id="end_date">
        <button type="submit" class="btn btn-primary">Fetch Data</button>
        <span class="loading loading-dots loading-lg htmx-indicator align-middle"></span>
        </form>

    </div>

    <div class="collapse collapse-plus max-w-fit bg-base-200 mt-5">
      <input type="checkbox" class="peer" />
      <div class="collapse-title text-lg font-medium cursor-pointer">
        ğŸ”‹ What's more than Google Search Console?
      </div>
      <div class="collapse-content">
        <p class="text-sm mt-2">
          ğŸ’¡ GSC Metrics(Clicks, Impressions, CTR, Positions) by Brand, Non Brand and Anonymized Queries
          <br>ğŸ“ˆ Pre-Built Charts for GSC Metrics by Brand vs Non Brand Queries
          <br>ğŸ“ˆ Query Count Charts by Brand vs Non Brand Queries
          <br>ğŸ“ˆ Query Count by Position Bucket Charts by Brand vs Non Brand Queries
          <br>ğŸ’¡ No Limit of 1000 Rows of Data
        </p>
      </div>
    </div>

   

  </div>



  <!-- Hidden skeleton template for JavaScript to reuse -->
  <div id="skeleton-template" style="display: none;">
    {% include '/sitewide-analysis/skeleton.html' %}
  </div>

  <!-- Content Area - Shows helpful message initially, replaced by skeleton/data when Fetch Data is clicked -->
  <div id="sitewide-analysis">
    <!-- Initial State - Only shown before user clicks Fetch Data -->
    <div class="mt-10 text-center">
      <div role="alert" class="alert alert-info shadow-lg max-w-2xl mx-auto mb-5">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
        <div>
          <h3 class="font-bold">Ready to analyze your data!</h3>
          <div class="text-sm">
            Select a date range above and click <strong>"Fetch Data"</strong> to see your sitewide brand vs non-brand analysis.
            <br>
            <span class="text-xs opacity-75 mt-2 block">
              ğŸ’¡ Tip: Start with a 7-day range for faster results, then expand if needed.
            </span>
          </div>
        </div>
      </div>
      
      <!-- Feature highlights -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 max-w-4xl mx-auto mt-8">
        <div class="card bg-base-200 shadow">
          <div class="card-body text-center">
            <div class="text-3xl mb-2">ğŸ“Š</div>
            <h3 class="card-title text-lg justify-center">GSC Metrics</h3>
            <p class="text-sm">Clicks, Impressions, CTR & Position by Brand vs Non-Brand</p>
          </div>
        </div>
        <div class="card bg-base-200 shadow">
          <div class="card-body text-center">
            <div class="text-3xl mb-2">ğŸ“ˆ</div>
            <h3 class="card-title text-lg justify-center">Interactive Charts</h3>
            <p class="text-sm">Pre-built visualizations with time-series analysis</p>
          </div>
        </div>
        <div class="card bg-base-200 shadow">
          <div class="card-body text-center">
            <div class="text-3xl mb-2">â™¾ï¸</div>
            <h3 class="card-title text-lg justify-center">No Limits</h3>
            <p class="text-sm">Export unlimited rows beyond GSC's 1,000 limit</p>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>



<script type="text/javascript">
  $(function() {
  
    var start = moment().subtract(9, 'days');
    var end = moment().subtract(2, 'days');
  
      function cb(start, end) {
          $('#reportrange span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
          $('#start_date').val(start.format('MM/DD/YYYY'));
          $('#end_date').val(end.format('MM/DD/YYYY'));
      }
  
      $('#reportrange').daterangepicker({
          startDate: start,
          endDate: end,
          ranges: {
             'Today': [moment(), moment()],
             'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
             'Last 7 Days': [moment().subtract(6, 'days'), moment()],
             'Last 30 Days': [moment().subtract(29, 'days'), moment()],
             'This Month': [moment().startOf('month'), moment().endOf('month')],
             'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
          }
      }, cb);
  
      cb(start, end);
  
  });

  // Show skeleton screen when HTMX request starts (user clicks Fetch Data)
  document.body.addEventListener('htmx:beforeRequest', function(event) {
    // Check if this is our form submission
    const form = event.detail.elt;
    if (form && form.id === 'dateRangeForm') {
      const target = document.getElementById('sitewide-analysis');
      const skeletonTemplate = document.getElementById('skeleton-template');
      
      if (target && skeletonTemplate) {
        // Always show skeleton when Fetch Data is clicked (replaces initial state or previous data)
        const skeletonHTML = skeletonTemplate.innerHTML;
        
        // Replace with skeleton immediately for better UX
        target.innerHTML = `
          <div role="alert" class="alert alert-info mt-5 mb-5">
            <span class="loading loading-spinner loading-sm"></span>
            <span>Loading data from Google Search Console... Please wait.</span>
          </div>
          ${skeletonHTML}
        `;
      }
    }
  });
</script>


{% endblock %}
